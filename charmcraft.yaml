# This file configures Charmcraft.
# See https://canonical-charmcraft.readthedocs-hosted.com/en/stable/reference/files/charmcraft-yaml-file/
type: charm
name: headscale-k8s
title: Headscale
summary: Headscale is an open source, self-hosted implementation of the Tailscale control server.
description: |
  This charm deploys headscale on top of kubernetes.

links:
  contact: mailto:marcus.boden@canonical.com
  issues:
  - https://github.com/marcusboden/headscale-k8s-operator/issues
  source:
  - https://github.com/marcusboden/headscale-k8s-operator
  - https://github.com/juanfont/headscale

base: ubuntu@24.04
platforms:
  amd64:

assumes:
  - k8s-api
  - juju >= 3.1

parts:
  charm:
    source: .
    source-type: local
    charm-requirements:
      - requirements.txt
    build-packages:
      - libssl-dev
      - pkg-config


config:
  options:
    log-level:
      description: |
        Configures the log level of headscale.
      default: "info"
      type: string
    name:
      description: |
        Hostname of the headscale server
      default: headscale
      type: string
    policy:
      description: |
        Policy file to use, see https://headscale.net/stable/ref/acls/
      type: string
    magic-dns:
      description: Name of the tld for the magic DNS. Set to an empty string to disable magic dns
      type: string
      default: headscale.test
    oidc_issuer:
      description: OIDC issuer URL. Required if any other OIDC config options are set.
      type: string
    oidc_client_id:
      description: OIDC Client ID. Required if any other OIDC config options are set.
      type: string
    oidc_secret:
      description: OIDC Client Secret. Required if any other OIDC config options are set.
      type: secret
    oidc_expiry:
      description: |
        Expiration time of nodes added via OIDC. A value of 0 disables this.
        Default: 1d, if nothing configured.
      type: string
    oidc_scope:
      description: OIDC scopes. Default '["openid", "profile", "email"]'
      type: string
    oidc_groups:
      description: Groups (as sent by the OIDC provider) that are allowed to login. If not set, all are allowed.
      type: string

containers:
  headscale:
    resource: headscale-image
    mounts:
    - storage: database
      location: /var/lib/headscale

resources:
  headscale-image:
    type: oci-image
    description: |
      OCI image for the headscale container

      see https://github.com/marcusboden/headscale-rock

requires:
  traefik-route:
    interface: traefik_route
    limit: 1
    optional: true
  certificates:
    interface: tls-certificates
    limit: 1
  logging:
    interface: loki_push_api
    optional: true

provides:
  metrics-endpoint:
    interface: prometheus_scrape
    limit: 1
    optional: true

storage:
  database:
    type: filesystem
    description: Storage Volume for the sqlite database

actions:
  create-authkey:
    description: Creates an Auth-key. We don't support different users.
    params:
      tags:
        type: string
        description: Tags to associate with this key
      expiry:
        type: string
        description: Human-readable expiration of the key (e.g. 30m, 24h) (default "1h")
      ephemeral:
        description: Make the Auth-key ephemera;
        type: boolean
      reusable:
        description: Make the Auth-key re-usable
        type: boolean
    required:
    - tags
    additionalProperties: false
  expire-authkey:
    description: Expires an Authkey
    params:
      authkey:
        type: string
        description: ID or Key to expire
    required:
    - authkey
    additionalProperties: false
  list-authkeys:
    description: Lists all Authkeys
    additionalProperties: false
  create-backup:
    description: |
      Creates a backup including the database and the noise key
      and places it into /tmp/backup/headscale-backup-<timestamp>.tar.gz.
      
      The operation returns a command to copy the backup off the machine.
    additionalProperties: false
  restore-backup:
    description: |
      Restores a backup created with the create-backup Action.
      WARNING: THIS OVERWRITES THE CURRENT DATABASE!
      (It does a backup first though, I'm not a monster!)
    params:
      backup-path:
        type: string
        description: Path to the backup file. You will have to manually copy it there first.
    required:
    - backup-path
    additionalProperties: false